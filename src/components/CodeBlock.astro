---
import { Icon } from 'astro-icon/components';
import type { HTMLAttributes } from 'astro/types';

type Props = HTMLAttributes<'pre'>;
---

<div class="codeblock">
  <button class="codeblock-copy" type="button" aria-label="Copy code to clipboard">
    <Icon name="lucide:copy" class="copy-icon" size={20} />
    <Icon name="lucide:check" class="check-icon" size={20} />
  </button>
  <pre {...Astro.props}><slot /></pre>
</div>

<style>
  .codeblock {
    position: relative;
  }

  .codeblock-copy {
    position: absolute;
    top: var(--space-sm);
    right: var(--space-sm);
    padding: 0;
    background: rgb(var(--color-bg-rgb) / var(--opacity-strong));
    backdrop-filter: blur(var(--blur-sm));
    border: var(--border-width) solid rgb(var(--color-text-rgb) / var(--opacity-subtle));
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all var(--transition-fast);
    opacity: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
  }

  .copy-icon,
  .check-icon {
    color: var(--color-text-muted);
    transition: color var(--transition-fast), opacity var(--transition-fast);
  }

  .codeblock:hover .codeblock-copy {
    opacity: 1;
  }

  .codeblock-copy:hover {
    background: rgb(var(--color-bg-rgb) / 0.95);
    border-color: var(--color-border);
  }

  .codeblock-copy:hover .copy-icon,
  .codeblock-copy:hover .check-icon {
    color: var(--color-text);
  }

  .codeblock-copy:active {
    transform: scale(0.95);
  }

  .check-icon {
    opacity: 0;
    position: absolute;
  }

  .codeblock-copy.copied .copy-icon {
    opacity: 0;
  }

  .codeblock-copy.copied .check-icon {
    opacity: 1;
  }

  .codeblock-copy.copied {
    color: var(--color-primary);
    border-color: var(--color-primary);
  }
</style>

<script>
  function initCopyButtons(): void {
    document.querySelectorAll<HTMLElement>('.codeblock').forEach((block) => {
      const button = block.querySelector<HTMLButtonElement>('.codeblock-copy');
      const pre = block.querySelector<HTMLPreElement>('pre');

      if (!button || !pre) return;

      const newButton = button.cloneNode(true) as HTMLButtonElement;
      button.replaceWith(newButton);

      newButton.addEventListener('click', async () => {
        const code = pre.textContent?.trim();
        if (!code) return;

        try {
          await navigator.clipboard.writeText(code);
          newButton.classList.add('copied');
          setTimeout(() => newButton.classList.remove('copied'), 2000);
        } catch (err) {
          console.error('Failed to copy code:', err);
        }
      });
    });
  }

  document.addEventListener('astro:page-load', initCopyButtons);
</script>
