---
import DateFormatter from "@components/DateFormatter.astro";
import BaseLayout from "@layouts/BaseLayout.astro";
import CodeBlock from "@components/CodeBlock.astro";
import Giscus from "@components/Giscus.astro";
import CopyPageButton from "@components/CopyPageButton.astro";
import SchemaOrg from "@components/SchemaOrg.astro";
import ArticleMeta from "@components/ArticleMeta.astro";
import { type CollectionEntry, getCollection, render } from "astro:content";

export const prerender = true;

export async function getStaticPaths() {
  const posts = await getCollection("blog");
  return posts.map((post: CollectionEntry<"blog">) => ({
    params: { slug: post.slug },
    props: post,
  }));
}

type Props = CollectionEntry<"blog">;

const post = Astro.props;
const { Content } = await render(post);

const { title, description, pubDate, updatedDate, category, tags, author, heroImage } = post.data;

function estimateReadingTime(content: string): number {
  const wordsPerMinute = 200;
  const wordCount = content.trim().split(/\s+/).length;
  return Math.ceil(wordCount / wordsPerMinute);
}

const readingTime = estimateReadingTime(post.body);
---

<BaseLayout title={title} description={description} image={heroImage}>
  <ArticleMeta
    pubDate={pubDate}
    updatedDate={updatedDate}
    author={author}
    category={category}
    tags={tags}
    image={heroImage}
  />
  <SchemaOrg
    type="BlogPosting"
    title={title}
    description={description}
    pubDate={pubDate}
    updatedDate={updatedDate}
    author={author}
    image={heroImage}
    slot="head"
  />
  <article>
    <header class="post-header">
      <h1>{title}</h1>
      <div class="post-meta">
        <div class="meta-left">
          <span class="published-label">Published</span>
          <time datetime={pubDate.toISOString().split("T")[0]}>
            <DateFormatter date={pubDate} />
          </time>
          <span class="separator">·</span>
          <span class="reading-time">{readingTime} min read</span>
          <span class="separator">·</span>
          <span class="category">{category}</span>
        </div>
        <CopyPageButton markdown={post.body} />
      </div>
    </header>
    <div class="prose">
      <Content components={{ pre: CodeBlock }} />
    </div>
    <Giscus />
  </article>
</BaseLayout>

<style>
  .post-header {
    margin-bottom: var(--space-xl);
    padding-bottom: calc(var(--space-xs) * 0.5);
    border-bottom: var(--border-width) solid var(--color-border);
  }

  .post-header h1 {
    font-family: var(--font-family-display);
    font-size: var(--text-2xl);
    font-weight: var(--font-weight-semibold);
    line-height: var(--line-height-tight);
    letter-spacing: var(--letter-spacing-tighter);
    word-spacing: var(--word-spacing-tight);
    margin-bottom: var(--space-md);
  }

  .post-meta {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: var(--space-xs);
    font-size: var(--text-xs);
    color: var(--color-text-muted);
  }

  .meta-left {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: var(--space-xs);
  }

  .separator {
    color: var(--color-text-subtle);
  }

  .category {
    color: var(--color-primary);
    text-transform: capitalize;
    font-weight: var(--font-weight-medium);
  }
</style>
