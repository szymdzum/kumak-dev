---
import DateFormatter from "@components/DateFormatter.astro";
import BaseLayout from "@layouts/BaseLayout.astro";
import CodeBlock from "@components/CodeBlock.astro";
import Giscus from "@components/Giscus.astro";
import CopyPageButton from "@components/CopyPageButton.astro";
import SchemaOrg from "@components/SchemaOrg.astro";
import ArticleMeta from "@components/ArticleMeta.astro";
import ArticleFooter from "@components/ArticleFooter.astro";
import FurtherReading from "@components/FurtherReading.astro";
import TableOfContents from "@components/TableOfContents.astro";
import { getCollection, render } from "astro:content";
import { estimateReadingTime, type BlogPost } from "@utils/posts";

export const prerender = true;

export async function getStaticPaths() {
  const posts = await getCollection("blog", ({ data }: BlogPost) => {
    return import.meta.env.DEV || !data.draft;
  });
  return posts.map((post: BlogPost) => ({
    params: { slug: post.slug },
    props: post,
  }));
}

type Props = BlogPost;

const post = Astro.props;
const { Content, headings } = await render(post);

const { title, description, pubDate, updatedDate, category, tags, author, heroImage, externalLinks } = post.data;

const readingTime = estimateReadingTime(post.body);
---

<BaseLayout title={title} description={description} image={heroImage}>
  <ArticleMeta
    pubDate={pubDate}
    updatedDate={updatedDate}
    author={author}
    category={category}
    tags={tags}
    image={heroImage}
    slot="head"
  />
  <SchemaOrg
    type="BlogPosting"
    title={title}
    description={description}
    pubDate={pubDate}
    updatedDate={updatedDate}
    author={author}
    image={heroImage}
    slot="head"
  />
  <div class="article-layout">
    <article>
      <header>
        <h1 id="top">{title}</h1>
        <div class="meta-row">
          <dl>
            <dt>Published</dt>
            <dd>
              <time datetime={pubDate.toISOString().split("T")[0]}>
                <DateFormatter date={pubDate} />
              </time>
            </dd>
            <dt>Reading time</dt>
            <dd><data value={readingTime}>{readingTime} min read</data></dd>
            <dt>Category</dt>
            <dd>{category}</dd>
          </dl>
          <CopyPageButton markdown={post.body} />
        </div>
      </header>
      <div class="prose">
        <Content components={{ pre: CodeBlock }} />
      </div>
      <FurtherReading links={externalLinks} />
      <ArticleFooter />
      <Giscus />
    </article>
    <TableOfContents headings={headings} title={title} />
  </div>
</BaseLayout>

<style>
  .article-layout {
    position: relative;
  }

  header {
    margin-bottom: var(--space-xl);
    padding-bottom: calc(var(--space-xs) * 0.5);
    border-bottom: var(--border-width) solid var(--color-border);
  }

  header h1 {
    font-family: var(--font-family-display);
    font-size: var(--text-2xl);
    font-weight: var(--font-weight-semibold);
    line-height: var(--line-height-tight);
    letter-spacing: var(--letter-spacing-tighter);
    word-spacing: var(--word-spacing-tight);
    margin-bottom: var(--space-md);
  }

  .meta-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: var(--space-xs);
  }

  header dl {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: var(--space-xs);
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    margin: 0;
  }

  header dt {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    border: 0;
  }

  header dd {
    margin: 0;
  }

  header dd + dd::before {
    content: "Â·";
    margin-right: var(--space-xs);
    color: var(--color-text-subtle);
  }

  header dd:last-of-type {
    color: var(--color-primary);
    text-transform: capitalize;
    font-weight: var(--font-weight-medium);
  }

  @media (max-width: 480px) {
    header h1 {
      font-size: var(--text-xl);
    }
  }
</style>
