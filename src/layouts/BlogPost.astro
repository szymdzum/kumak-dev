---
import type { CollectionEntry } from "astro:content";
import Layout from "@layouts/Layout.astro";
import FormattedDate from "@components/FormattedDate.astro";
import TableOfContents from "@components/TableOfContents.astro";
import Tags from "@components/Tags.astro";
import CategoryBadge from "@components/CategoryBadge.astro";
import RelatedPosts from "@components/RelatedPosts.astro";
import { formatReadingTime } from "@utils/readingTime";
import { getRelatedPosts } from "@utils/relatedPosts";
import { getCollection } from "astro:content";
import { BlogRoutes } from "@utils/url.ts";

type Props = CollectionEntry<"blog">["data"] & {
  headings?: Array<{
    depth: number;
    slug: string;
    text: string;
  }>;
  id?: string;
  slug?: string;
  body?: string;
};

const {
  title,
  description,
  pubDate,
  updatedDate,
  heroImage,
  draft,
  category,
  tags,
  showToc,
  headings = [],
  id,
  slug,
  body = ""
} = Astro.props;

// Get related posts if we have the necessary data
let relatedPosts: CollectionEntry<"blog">[] = [];
if (id || slug) {
  const allPosts = await getCollection("blog");
  const currentPost = allPosts.find((p: CollectionEntry<"blog">) => p.id === id || p.slug === slug);
  if (currentPost) {
    relatedPosts = getRelatedPosts(currentPost, allPosts, 5);
  }
}

const readingTime = formatReadingTime(body);
const showTableOfContents = showToc && headings.length > 3;
---

<Layout title={title} description={description}>

  <article class={`article ${showTableOfContents ? 'article--with-toc' : ''}`}>
    {heroImage && (
      <figure class="hero-image">
        <img src={heroImage} alt={title} />
      </figure>
    )}

    <header class="article__header">
      <div class="article__meta">
        <CategoryBadge category={category} href={BlogRoutes.category(category)} />
        {draft && import.meta.env.DEV && (
          <span class="draft-badge">DRAFT</span>
        )}
        <span class="separator" aria-hidden="true">•</span>
        <time datetime={pubDate.toISOString().split('T')[0]}>
          <FormattedDate date={pubDate} />
        </time>
        <span class="separator" aria-hidden="true">•</span>
        <span class="reading-time">{readingTime}</span>
      </div>

      <h1 class="article__title">{title}</h1>

      <p class="article__description">{description}</p>

      {tags && tags.length > 0 && (
        <div class="article__tags">
          <Tags tags={tags} />
        </div>
      )}

      {updatedDate && (
        <div class="article__updated">
          <time datetime={updatedDate.toISOString().split('T')[0]}>
            Last updated: <FormattedDate date={updatedDate} />
          </time>
        </div>
      )}
    </header>

    {showTableOfContents && (
      <aside class="toc-sidebar" aria-label="Table of Contents">
        <TableOfContents headings={headings} />
      </aside>
    )}

    <div class="article__body prose">
      <slot />
    </div>

    {relatedPosts.length > 0 && (
      <section aria-label="Related Posts">
        <RelatedPosts posts={relatedPosts} />
      </section>
    )}
  </article>
</Layout>
